$(document).ready(function () {

	var importantdata = $('#important-data').text();
    var obj = JSON.parse(importantdata);
    var solrUrl = obj.solrUrl;
	var siteName = obj.siteName;

    var myDataUrl = `${solrUrl}/select?q=pageType%3ANews&omitHeader=true&rows=1000&fq=siteName_s:` + siteName +"&sort=newsFromDate%20desc";
    const monthNames = ["January", "February", "March", "April", "May", "June",
     "July", "August", "September", "October", "November", "December"];
	var defaultImgPath = '/content/dam/sites/isb/images/comunity06-a.jpg';
	
	   
     // Create session variables for filter options
     sessionStorage.setItem('tagValue', '');
     sessionStorage.setItem('subTagValue', '');
     sessionStorage.setItem('searchText', '');
   
     var params = '';


	const queryString = window.location.search;
	const urlParams = new URLSearchParams(queryString);
	let cat = urlParams.has('cat') ? urlParams.get('cat') : '';
	let subcat = urlParams.has('subcat') ? urlParams.get('subcat') : '';
	if(urlParams != null) {
		sessionStorage.setItem('tagValue', cat);
        sessionStorage.setItem('subTagValue', subcat);
			
	    let param1 = (cat != '') ? `&fq=tagValue:"${cat}"` : '';
	    let param2 = (subcat != '') ? `&fq=subTagValue:"${subcat}"` : '';
	
	    params = param1 + param2;

    	$('.row.blog-grid').html('');
         myDataUrl = `${solrUrl}/select?q=pageType%3ANews${params}&omitHeader=true&rows=100&fq=siteName_s:` + siteName +"&sort=newsFromDate%20desc";
       
	}

     /**
      * Create options for filter
      */
     function generateOptions(arr, element) {
         // Remove Duplicate items
       let dataArr = arr.toString().split(',');
       var data = dataArr.filter(function (elem, index, self) {
         return index === self.indexOf(elem);
       });
   
       // Create option and insert to select tag
       for (let i = 0; i < data.length; i++) {
         if(i == 0 && data.length > 1) {
             let allOption = `<option value="">All</option>`;
             $(element).append(allOption);
         }
         if (data[i] != '' && data[i] != undefined && data[i] != "null") {
           let maincategory = `<option value="${data[i]}">${data[i]}</option>`;
           $(element).append(maincategory);
         }
       }
     }
   
     /**
      * ajax call to fetch the data from solr
      * @param myDataUrl page URL
      * @param isUpdateFilters true|false If true update select tag data
      */
     function ajaxCall(myDataUrl, isUpdateFilters) {
       $.ajax({
         url: myDataUrl,
         type: "GET",
         success: function (searchresponse) {
            let rankCount = 1;
        	let facultyrankCount = 1;
            var results = searchresponse['response'];
            var docs = results['docs'];
   
           if (isUpdateFilters == true) {
   
             // Empty the options
             $('.newsmaincategory, .newssubcategory').find('option').remove().end().append('').val('');
   
   
             let categoryArr = [];
               let subCatergoryArr = [];
               for (let i = 0; i < docs.length; i++) {

                   let tagArr = docs[i].tagValue ? docs[i].tagValue.toString().split('|') : '';
                   for(let j = 0; j < tagArr.length ; j++) {
                       categoryArr.push($.trim(tagArr[j]));
                   }

                   let subTagArr = docs[i].subTagValue ? docs[i].subTagValue.toString().split('|') : '';
                   for(let k = 0; k < subTagArr.length ; k++) {
                       subCatergoryArr.push($.trim(subTagArr[k]));
                   }
               }
   
               generateOptions(categoryArr, '.newsmaincategory.selectpicker');
               generateOptions(subCatergoryArr, '.newssubcategory.selectpicker');
   
               $(".selectpicker").selectpicker("refresh");
           }
   
           /**
            * Page Template
            */
           const htmlTemplate = `${docs.map(item => `<div class="col-md-4 col-sm-4 col-xs-12 blogcard-count">
           <div class="blog-card">
            <a href="${item.url}" class="link-card get-ranks" title="" data-isb-search-info='{"rank":"${rankCount++}", "linkUrl":"${item.url}", "category": "${item.subTagValue !== undefined ? item.subTagValue : ''}", "resultType":"${item.title !== undefined ? item.title : ''}"}'></a>
             <figure><img src="${item.gridImage ? `${item.gridImage}` : defaultImgPath }" alt="${item.imageAltText}" style="width: 100%;"></figure>
             <div class="news-ctnt">
               <p class="${item.subTagValue ? 'tag' : ''}">
                   <span>${item.subTagValue ? item.subTagValue : ''}</span>
               </p>
               <p class="font-18b">${item.title ? item.title : ''}</p>
               <p class="font-16">${item.description ? item.description : ''}</p>
               <p class="font-14">${item.newsFromDate ? new Date(item.newsFromDate).getDate() : ''} ${item.newsFromDate ? monthNames[new Date(item.newsFromDate).getMonth()] : ''} ${item.newsFromDate ? new Date(item.newsFromDate).getFullYear() : ''}</p>
             </div>
           </div>
         </div>`).join('')}`;

            if(htmlTemplate !== '') {
               $('.row.blog-grid').append(htmlTemplate);
               $('.listing-grid').show();
           } else {
               const htmlTemplate = `<div class="acc-text text-center">Please refine your search!</div>`;
               $('.row.blog-grid').append(htmlTemplate);
           }
			setTimeout(function(){ 
                $('.upcoming-event-slider').removeClass('slick-initialized');
                paginationScript(); 
            }, 100);
   
             	var type = "News";
                let searchText = sessionStorage.getItem('searchText');
                var term = searchText;
                var blogGridDetailsArr = [];
                let resultCount = results.numFound;
                let tagValue = sessionStorage.getItem('tagValue') === '' ? 'All':sessionStorage.getItem('tagValue');
                let subTagValue = sessionStorage.getItem('subTagValue') === '' ? 'All':sessionStorage.getItem('subTagValue');
                blogGridDetailsArr.push(tagValue, subTagValue);
                let filters = blogGridDetailsArr.join("|");
                makeSearchAACall(type, '', term, resultCount, filters);

         },
         error: function (responseError) {
             var serverDownMessage = obj.serverDownMessage;
             $('.row.blog-grid').append(serverDownMessage);
             $('.listing-grid').show();
             $('.pagi-cta').hide();
           console.log(`Error ${responseError}`);
         }
       });
     }


	function filterItems() {
	   let tagValue = encodeURIComponent(sessionStorage.getItem('tagValue'));
       let subTagValue = encodeURIComponent(sessionStorage.getItem('subTagValue'));
       let searchText = sessionStorage.getItem('searchText');

       let param1 = (tagValue != '') ? `&fq=tagValue:"${tagValue}"` : '';
       let param2 = (subTagValue != '') ? `&fq=subTagValue:"${subTagValue}"` : '';
       let param3 = (searchText != '') ? `&fq=*${searchText}*` : '';

       params = param1 + param2 + param3;

       $('.row.blog-grid').html('');
         myDataUrl = `${solrUrl}/select?q=pageType%3ANews${params}&omitHeader=true&rows=100&fq=siteName_s:` + siteName +"&sort=newsFromDate%20desc";
       ajaxCall(myDataUrl, false);
    }

     /**
      * Filter option
      */
     $('select').on('change', function (e) {
		sessionStorage.setItem(this.name, this.value);
		 filterItems();
     });

   
     // Load data
     ajaxCall(myDataUrl, true);  
   
     /**
      * Search option
      */
     $('.search').keypress(function (event) {
       sessionStorage.setItem('searchText', '');
   
       var keycode = (event.keyCode ? event.keyCode : event.which);
   
       if (keycode == '13') {
         event.preventDefault();
         var searchText = $(this).val().trim();
         if (searchText.length >= 3 || searchText.length == 0) {
           sessionStorage.setItem('searchText', searchText);
           filterItems();
         }
       }
   
     }); 
   });
